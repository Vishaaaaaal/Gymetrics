/**
 * Gymetrics Dynamic Pricing Calculator
 * Features tier-based pricing, monthly/yearly billing, and coupon discounts
 */

// Feature definitions with BASE costs
const FEATURES = {
    adminApp: {
        name: 'Admin App',
        icon: `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
            <line x1="3" y1="9" x2="21" y2="9"></line>
            <line x1="9" y1="21" x2="9" y2="9"></line>
        </svg>`,
        description: 'Gym management dashboard',
        multipliesWithUsers: false,
        features: [
            { id: 'member-management', name: 'Member Management', tooltip: 'Add, edit, remove gym members', basePrice: 100 },
            { id: 'payment-billing', name: 'Automated Payments and Billing', tooltip: 'Manage subscriptions and payments', basePrice: 150 },
            { id: 'staff-management', name: 'Staff Management', tooltip: 'Manage trainers and staff schedules', basePrice: 100 },
            { id: 'analytics-dashboard', name: 'Analytics Dashboard', tooltip: 'Insights on gym usage and revenue', basePrice: 500 },
            { id: 'attendance-tracking', name: 'Attendance Tracking', tooltip: 'Track member check-ins and check-outs', basePrice: 150 }
        ]
    },
    userApp: {
        name: 'User App',
        icon: `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <rect x="5" y="2" width="14" height="20" rx="2" ry="2"></rect>
            <line x1="12" y1="18" x2="12.01" y2="18"></line>
        </svg>`,
        description: 'Member mobile experience',
        multipliesWithUsers: true,
        features: [
            { id: 'workout-logging', name: 'Workout Logging', tooltip: 'Log and track workout sessions', basePrice: 0.5 },
            { id: 'workout-scheduling', name: 'Workout Scheduling', tooltip: 'Schedule workout sessions', basePrice: 0.5 },
            { id: 'workout-tracking', name: 'Workout Tracking', tooltip: 'Track workout progress over time', basePrice: 1.5 },
            { id: 'ai-workout-generator', name: 'AI Workout Generator', tooltip: 'Generate personalized AI workouts', basePrice: 5 },
            { id: 'analytics-dashboard-user', name: 'Analytics Dashboard', tooltip: 'Personal fitness analytics', basePrice: 5 },
            { id: 'nutrition-services', name: 'Nutrition Services', tooltip: 'Personalized nutrition guidance', basePrice: 30 },
            { id: 'push-notifications', name: 'Push Notifications', tooltip: 'Reminders and updates for members', basePrice: 0.25 }
        ]
    },
    addons: {
        name: 'Add-ons',
        icon: `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="10"></circle>
            <line x1="12" y1="8" x2="12" y2="16"></line>
            <line x1="8" y1="12" x2="16" y2="12"></line>
        </svg>`,
        description: 'Premium enhancements',
        multipliesWithUsers: false,
        features: [
            { id: 'facial-recognition', name: 'Facial Recognition Entry', tooltip: 'AI-powered contactless check-in', basePrice: 500 },
            { id: 'equipment-tracking', name: 'Equipment Tracking', tooltip: 'Monitor equipment usage and maintenance', basePrice: 750 },
            { id: 'equipment-usage', name: 'Equipment Usage', tooltip: 'Track equipment utilization patterns', basePrice: 750 }
        ]
    }
};

// Plan configuration with tier multipliers
const PLAN_RANGES = [
    { name: 'small', min: 0, max: 50, label: 'Small Gym', multiplier: 1.0 },
    { name: 'growing', min: 50, max: 150, label: 'Growing Gym', multiplier: 1.15 },
    { name: 'big', min: 150, max: 300, label: 'Big Gym', multiplier: 1.40 },
    { name: 'large', min: 300, max: Infinity, label: 'Large Gym', multiplier: 2.0 }
];

// State
const state = {
    memberCount: 100,
    activePlan: 'growing',
    isYearly: false,
    yearlyDiscount: 0.25,
    couponApplied: false,
    couponDiscount: 0.25,
    prices: {
        small: { monthly: 0, yearly: 0 },
        growing: { monthly: 0, yearly: 0 },
        big: { monthly: 0, yearly: 0 },
        large: { monthly: 0, yearly: 0 }
    }
};

// DOM elements
const elements = {
    memberCount: document.getElementById('memberCount'),
    recommendedPlan: document.getElementById('recommendedPlan'),
    rangeMarker: document.getElementById('rangeMarker'),
    billingToggle: document.getElementById('billingToggle'),
    couponInput: document.getElementById('couponInput'),
    couponApplyBtn: document.getElementById('applyCoupon'),
    couponMessage: document.getElementById('couponMessage'),
    toast: document.getElementById('toast')
};

function init() {
    renderFeatures();
    setupEventListeners();
    updatePlanSelection(state.memberCount);
    updatePriceBreakdownDisplay();
}

function renderFeatures() {
    const container = document.getElementById('featureCategories');
    const plans = ['small', 'growing', 'big', 'large'];

    Object.keys(FEATURES).forEach(categoryKey => {
        const category = FEATURES[categoryKey];
        const categoryClass = categoryKey === 'adminApp' ? 'admin-icon' : categoryKey === 'userApp' ? 'user-icon' : 'addon-icon';

        const categoryHTML = `
            <div class="feature-category">
                <div class="category-header" onclick="toggleCategory(this)">
                    <span class="category-icon ${categoryClass}">${category.icon}</span>
                    <h4>${category.name}</h4>
                    <span class="category-desc">${category.description}</span>
                    <span class="expand-icon">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="6,9 12,15 18,9"></polyline>
                        </svg>
                    </span>
                </div>
                <div class="category-content expanded">
                    ${category.features.map(feature => `
                        <div class="feature-row" data-feature="${feature.id}">
                            <div class="feature-info">
                                <label class="feature-name">
                                    ${feature.name}
                                    <span class="info-tooltip" data-tooltip="${feature.tooltip}">â“˜</span>
                                </label>
                            </div>
                            <div class="plan-cells">
                                ${plans.map(plan => `
                                    <div class="plan-cell" data-plan="${plan}">
                                        <label class="custom-checkbox">
                                            <input type="checkbox" 
                                                data-feature="${feature.id}" 
                                                data-plan="${plan}" 
                                                data-base-price="${feature.basePrice}"
                                                data-multiplies="${category.multipliesWithUsers}"
                                                data-category="${categoryKey}">
                                            <span class="checkmark"></span>
                                        </label>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `).join('')}
                </div>
            </div>
        `;

        container.insertAdjacentHTML('beforeend', categoryHTML);
    });
}

function setupEventListeners() {
    elements.memberCount.addEventListener('input', (e) => {
        const count = parseInt(e.target.value) || 0;
        updatePlanSelection(count);
    });

    if (elements.billingToggle) {
        elements.billingToggle.addEventListener('change', handleBillingToggle);
    }

    if (elements.couponApplyBtn) {
        elements.couponApplyBtn.addEventListener('click', applyCoupon);
    }

    document.addEventListener('change', (e) => {
        if (e.target.type === 'checkbox' && e.target.dataset.plan) {
            handleCheckboxChange(e.target);
        }
    });

    updateToggleLabels();
}

function handleBillingToggle() {
    state.isYearly = elements.billingToggle.checked;
    updateToggleLabels();
    updatePriceBreakdownDisplay();
    updatePriceDisplays();
    showToast(state.isYearly ? 'Switched to yearly billing (25% off!)' : 'Switched to monthly billing');
}

function updatePriceBreakdownDisplay() {
    const plans = ['small', 'growing', 'big', 'large'];

    plans.forEach(plan => {
        const header = document.querySelector(`.plan-header[data-plan="${plan}"]`);
        if (!header) return;

        const priceBreakdown = header.querySelector('.price-breakdown');
        if (!priceBreakdown) return;

        const priceRows = priceBreakdown.querySelectorAll('.price-row');
        const monthlyRow = priceRows[0];
        const yearlyRow = priceRows[1];
        const yearlyPerMonthRow = priceRows[2];

        if (state.isYearly) {
            monthlyRow.classList.add('strikethrough');
            yearlyRow.classList.add('yearly-selected');
            yearlyPerMonthRow.classList.add('yearly-selected');
            yearlyPerMonthRow.style.display = 'flex';
        } else {
            monthlyRow.classList.remove('strikethrough');
            yearlyRow.classList.remove('yearly-selected');
            yearlyPerMonthRow.classList.remove('yearly-selected');
            yearlyPerMonthRow.style.display = 'none';
        }
    });
}

function updateToggleLabels() {
    const labels = document.querySelectorAll('.toggle-label');
    labels.forEach(label => {
        const billingType = label.dataset.billing;
        if ((billingType === 'yearly' && state.isYearly) ||
            (billingType === 'monthly' && !state.isYearly)) {
            label.classList.add('active');
        } else {
            label.classList.remove('active');
        }
    });
}

function applyCoupon() {
    const couponCode = elements.couponInput.value.trim().toUpperCase();

    if (state.couponApplied) {
        state.couponApplied = false;
        elements.couponMessage.textContent = 'Coupon removed';
        elements.couponMessage.className = 'coupon-message info';
        elements.couponApplyBtn.textContent = 'Apply';
        elements.couponInput.disabled = false;
        elements.couponInput.value = '';
        calculateAllPrices();
        showToast('Coupon removed');
        return;
    }

    if (couponCode === 'EARLY25') {
        state.couponApplied = true;
        elements.couponMessage.textContent = 'âœ“ Coup applied! 25% early customer discount';
        elements.couponMessage.className = 'coupon-message success';
        elements.couponApplyBtn.textContent = 'Remove';
        elements.couponInput.disabled = true;
        calculateAllPrices();
        showToast('ðŸŽ‰ Coupon applied! 25% off');
    } else {
        elements.couponMessage.textContent = 'âœ— Invalid coupon code';
        elements.couponMessage.className = 'coupon-message error';
    }
}

function updatePlanSelection(memberCount) {
    state.memberCount = memberCount;
    const activePlan = PLAN_RANGES.find(p => memberCount >= p.min && memberCount < p.max) || PLAN_RANGES[3];
    state.activePlan = activePlan.name;
    elements.recommendedPlan.textContent = activePlan.label;
    updateRangeMarker(memberCount);
    updatePlanStates();
    calculateAllPrices();
}

function updateRangeMarker(count) {
    const maxDisplay = 500;
    const clampedCount = Math.min(count, maxDisplay);
    const percentage = (clampedCount / maxDisplay) * 100;
    elements.rangeMarker.style.left = `${percentage}%`;

    document.querySelectorAll('.range-segment').forEach(segment => {
        segment.classList.remove('active');
    });
    const activeSegment = document.querySelector(`.range-segment[data-plan="${state.activePlan}"]`);
    if (activeSegment) activeSegment.classList.add('active');
}

function updatePlanStates() {
    const plans = ['small', 'growing', 'big', 'large'];

    plans.forEach(plan => {
        const isActive = plan === state.activePlan;

        const header = document.querySelector(`.plan-header[data-plan="${plan}"]`);
        if (header) {
            if (isActive) {
                header.classList.add('active');
                header.classList.remove('disabled');
                const btn = header.querySelector('.cta-btn');
                if (btn) {
                    btn.classList.remove('secondary');
                    btn.classList.add('primary');
                }
            } else {
                header.classList.remove('active');
                header.classList.add('disabled');
                const btn = header.querySelector('.cta-btn');
                if (btn) {
                    btn.classList.remove('primary');
                    btn.classList.add('secondary');
                }
            }
        }

        const cells = document.querySelectorAll(`.plan-cell[data-plan="${plan}"]`);
        cells.forEach(cell => {
            const checkbox = cell.querySelector('input[type="checkbox"]');
            if (checkbox) {
                checkbox.disabled = !isActive;
                if (!isActive) {
                    checkbox.checked = false;
                }
            }
            cell.classList.toggle('disabled', !isActive);
        });

        const summaryItem = document.querySelector(`.summary-item[data-plan="${plan}"]`);
        if (summaryItem) {
            summaryItem.classList.toggle('active', isActive);
            summaryItem.classList.toggle('disabled', !isActive);
        }
    });
}

function handleCheckboxChange(checkbox) {
    const plan = checkbox.dataset.plan;

    if (plan !== state.activePlan) {
        checkbox.checked = false;
        return;
    }

    calculateAllPrices();
    showToast(checkbox.checked ? 'Feature added!' : 'Feature removed');
}

function calculateFeaturePrice(basePrice, plan, multipliesWithUsers) {
    const planData = PLAN_RANGES.find(p => p.name === plan);
    const tierMultiplier = planData.multiplier;

    let price = basePrice * tierMultiplier;

    if (multipliesWithUsers) {
        price *= state.memberCount;
    }

    return price;
}

function calculateAllPrices() {
    const plans = ['small', 'growing', 'big', 'large'];

    plans.forEach(plan => {
        let monthlyTotal = 0;

        const checkboxes = document.querySelectorAll(`input[type="checkbox"][data-plan="${plan}"]:checked`);

        checkboxes.forEach(checkbox => {
            const basePrice = parseFloat(checkbox.dataset.basePrice) || 0;
            const multipliesWithUsers = checkbox.dataset.multiplies === 'true';

            const featurePrice = calculateFeaturePrice(basePrice, plan, multipliesWithUsers);
            monthlyTotal += featurePrice;
        });

        if (state.couponApplied) {
            monthlyTotal *= (1 - state.couponDiscount);
        }

        const yearlyTotal = monthlyTotal * 12 * (1 - state.yearlyDiscount);

        state.prices[plan] = {
            monthly: Math.round(monthlyTotal),
            yearly: Math.round(yearlyTotal)
        };
    });

    updatePriceDisplays();
}

function updatePriceDisplays() {
    const plans = ['small', 'growing', 'big', 'large'];

    plans.forEach(plan => {
        const monthlyPrice = state.prices[plan].monthly;
        const yearlyPrice = state.prices[plan].yearly;
        const yearlyPerMonth = Math.round(yearlyPrice / 12);

        const priceMonthly = document.getElementById(`price-${plan}-monthly`);
        const priceYearly = document.getElementById(`price-${plan}-yearly`);
        const priceYearlyPerMonth = document.getElementById(`price-${plan}-yearly-per-month`);

        if (priceMonthly) priceMonthly.textContent = monthlyPrice.toLocaleString('en-IN');
        if (priceYearly) priceYearly.textContent = yearlyPrice.toLocaleString('en-IN');
        if (priceYearlyPerMonth) priceYearlyPerMonth.textContent = yearlyPerMonth.toLocaleString('en-IN');

        const summaryMonthly = document.getElementById(`total-${plan}-monthly`);
        const summaryYearly = document.getElementById(`total-${plan}-yearly`);

        if (summaryMonthly) summaryMonthly.textContent = monthlyPrice.toLocaleString('en-IN');
        if (summaryYearly) summaryYearly.textContent = yearlyPrice.toLocaleString('en-IN');
    });
}

function toggleCategory(header) {
    const content = header.nextElementSibling;
    const isExpanded = content.classList.contains('expanded');

    if (isExpanded) {
        content.classList.remove('expanded');
        header.classList.add('collapsed');
    } else {
        content.classList.add('expanded');
        header.classList.remove('collapsed');
    }
}

function showToast(message) {
    const toastMessage = elements.toast.querySelector('.toast-message');
    toastMessage.textContent = message;
    elements.toast.classList.add('show');
    setTimeout(() => { elements.toast.classList.remove('show'); }, 2000);
}

function selectPlan(plan) {
    if (plan !== state.activePlan) {
        showToast('Please adjust member count to select this plan');
        return;
    }

    const planData = PLAN_RANGES.find(p => p.name === plan);
    showToast(`${planData.label} selected!`);
    console.log('Selected plan:', plan, state.prices[plan]);
}

document.addEventListener('DOMContentLoaded', init);
